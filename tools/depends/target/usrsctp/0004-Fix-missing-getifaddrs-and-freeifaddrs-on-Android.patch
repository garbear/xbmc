From 03b18cc4b10cf159d7f7001b0a7e81a68e8d54f2 Mon Sep 17 00:00:00 2001
From: Garrett Brown <themagnificentmrb@gmail.com>
Date: Sat, 5 Aug 2023 15:53:34 -0700
Subject: [PATCH 4/4] Fix missing getifaddrs() and freeifaddrs() on Android

---
 usrsctplib/CMakeLists.txt              |  2 ++
 usrsctplib/netinet/ifaddrs-android.c   | 29 +++++++++++++++++++++++++
 usrsctplib/netinet/ifaddrs-android.h   | 30 ++++++++++++++++++++++++++
 usrsctplib/netinet/sctp_os_userspace.h |  5 +++++
 4 files changed, 66 insertions(+)
 create mode 100644 usrsctplib/netinet/ifaddrs-android.c
 create mode 100644 usrsctplib/netinet/ifaddrs-android.h

diff --git a/usrsctplib/CMakeLists.txt b/usrsctplib/CMakeLists.txt
index 6cb85dc..6f536ac 100644
--- a/usrsctplib/CMakeLists.txt
+++ b/usrsctplib/CMakeLists.txt
@@ -120,6 +120,7 @@ list(APPEND usrsctp_root_headers
 )
 
 list(APPEND usrsctp_netinet_headers
+	netinet/ifaddrs-android.h
 	netinet/sctp_asconf.h
 	netinet/sctp_auth.h
 	netinet/sctp_bsd_addr.h
@@ -157,6 +158,7 @@ list(APPEND usrsctp_headers
 )
 
 list(APPEND usrsctp_sources
+	netinet/ifaddrs-android.c
 	netinet/sctp_asconf.c
 	netinet/sctp_auth.c
 	netinet/sctp_bsd_addr.c
diff --git a/usrsctplib/netinet/ifaddrs-android.c b/usrsctplib/netinet/ifaddrs-android.c
new file mode 100644
index 0000000..9a340d4
--- /dev/null
+++ b/usrsctplib/netinet/ifaddrs-android.c
@@ -0,0 +1,29 @@
+/*
+ * Copyright (C) 2009 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#include "ifaddrs-android.h"
+
+#if defined(__ANDROID__) && __ANDROID_API__ < 24
+
+int getifaddrs(struct ifaddrs** result) {
+    *result = NULL;
+    return 0;
+}
+
+void freeifaddrs(struct ifaddrs* addresses) {
+}
+
+#endif
diff --git a/usrsctplib/netinet/ifaddrs-android.h b/usrsctplib/netinet/ifaddrs-android.h
new file mode 100644
index 0000000..95d0cd3
--- /dev/null
+++ b/usrsctplib/netinet/ifaddrs-android.h
@@ -0,0 +1,30 @@
+/*
+ * Copyright (C) 2009 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+#ifndef IFADDRS_ANDROID_H_included
+#define IFADDRS_ANDROID_H_included
+
+#if defined(__ANDROID__) && __ANDROID_API__ < 24
+
+#include <ifaddrs.h>
+#include <stddef.h>
+
+int getifaddrs(struct ifaddrs** result);
+
+void freeifaddrs(struct ifaddrs* addresses);
+
+#endif // defined(__ANDROID__) && __ANDROID_API__ < 24
+
+#endif  // IFADDRS_ANDROID_H_included
diff --git a/usrsctplib/netinet/sctp_os_userspace.h b/usrsctplib/netinet/sctp_os_userspace.h
index 493ae02..7e77a1b 100755
--- a/usrsctplib/netinet/sctp_os_userspace.h
+++ b/usrsctplib/netinet/sctp_os_userspace.h
@@ -480,6 +480,11 @@ struct sx {int dummy;};
 #if !defined(_WIN32)
 #if defined(INET) || defined(INET6)
 #include <ifaddrs.h>
+
+// Android doesn't provide getifaddrs() or freeifaddrs() below API level 24
+#if defined(__ANDROID__) && __ANDROID_API__ < 24
+#include "ifaddrs-android.h"
+#endif
 #endif
 
 /* for ioctl */
-- 
2.34.1

